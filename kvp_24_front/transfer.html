<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Формирование перевода</title>
    <link rel="stylesheet" href="css/transfer.css">
</head>

<body>
    <h1>Формирование перевода</h1>

    <form id="transfer-form">
        <!-- Селект для выбора поставщика услуг -->
        <label for="provider-select">Выберите поставщика услуг:</label>
        <select id="provider-select" required>
            <option value="">-- Выберите --</option>
        </select>

        <!-- Сумма непереведенных платежей -->
        <p>Непереведенные платежи: <span id="untransferred-payments">0.00</span> руб.</p>

        <!-- Ввод суммы перевода -->
        <label for="transfer-amount">Введите сумму перевода:</label>
        <input type="number" id="transfer-amount" placeholder="Сумма перевода" step="0.01" required>

        <button type="button" onclick="processFundsTransfer()">Создать перевод</button>
    </form>

    <div id="transfer-result"></div>
    <a href="index.html">На главную</a>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const providerSelect = document.getElementById("provider-select");
            const untransferredPaymentsSpan = document.getElementById("untransferred-payments");

            providerSelect.addEventListener("change", async () => {
                const providerId = providerSelect.value;

                // Если поставщик не выбран, обнуляем сумму
                if (!providerId) {
                    untransferredPaymentsSpan.textContent = "0.00";
                    return;
                }

                try {
                    // Отправляем запрос к API
                    const response = await fetch(`/getSum?providerId=${providerId}`);
                    if (response.ok) {
                        const sum = await response.json();
                        untransferredPaymentsSpan.textContent = sum.toFixed(2); // Обновляем сумму
                    } else {
                        console.error("Ошибка при получении суммы платежей:", response.status);
                        untransferredPaymentsSpan.textContent = "0.00";
                    }
                } catch (error) {
                    console.error("Ошибка подключения к серверу:", error);
                    untransferredPaymentsSpan.textContent = "0.00";
                }
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            // URL вашего API
            const apiUrl = "http://localhost:8080/serviceProviders"; // Укажите правильный URL

            // Элемент <select>
            const providerSelect = document.getElementById("provider-select");

            // Функция для загрузки поставщиков услуг
            function loadServiceProviders() {
                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Ошибка загрузки данных: " + response.status);
                        }
                        return response.json();
                    })
                    .then(providers => {
                        providers.forEach(provider => {
                            const option = document.createElement("option");
                            option.value = provider.id; // Предположим, у поставщика есть поле `id`
                            option.textContent = provider.name; // Предположим, у поставщика есть поле `name`
                            providerSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error("Ошибка при загрузке поставщиков услуг:", error);
                    });
            }

            // Вызов функции при загрузке страницы
            loadServiceProviders();
        });
    </script>
</body>

</html>